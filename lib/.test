const constants = require("./constants.js");
const uid = require("./uid.js");
const lodashSet = require("lodash.set");
const lodashGet = require("lodash.get");
const getAncestorPath = require("./get-ancestor-path.js");

//constants.idHashmap[constants.prefix] = `${constants.prefix}-${uid(constants.idLength)}`;


const testh = {};
module.exports = function scanObject(obj, callback, parent) {
	if (!obj instanceof Object || typeof callback != "function") return;
	let keys = Object.keys(obj);

	//Scan the object
	for (var i = 0; i < keys.length; i++) {
		let key = keys[i];
		let value = obj[key];
		if (parent) {
			value.parent = parent;
		} else value.parent = obj;

		//Set value name as key's name
		value.name = key;

		//If content object is missing inside the value, then add an empty content object
		value.content = !value.content ? {} : value.content;

		//Check if the id hashmap doesn't contain the name yet
		if (!constants.idHashmap[key]) {
			//If it doesn't, then add it to id hashmap
			//constants.idHashmap[key] = `${constants.prefix}-${value.type}-${uid(constants.idLength)}`;
		}

		var ancestorPath = getAncestorPath(value).objectPath;

		if (!lodashGet(constants.idHashmap, ancestorPath)) {
			lodashSet(constants.idHashmap, ancestorPath, `${constants.prefix}-${value.type}-${uid(constants.idLength)}`);

			var directoryPath = getAncestorPath(value.parent).objectPath + `[${constants.prefix}-directory-id]`;
			var directoryId = `${constants.prefix}-${value.parent.type}-${uid(constants.idLength)}`;
			if (getAncestorPath(value.parent).objectPath == "['treeview']") {
				directoryId = `${constants.prefix}-main`;
			}
			lodashSet(constants.idHashmap, directoryPath, directoryId);
		}

		if (value.type == "file") {
			callback(value);
		} else if (value.type == "directory") {
			callback(value);

			//Recursion
			scanObject(value.content, callback, value);
		}
	}
}
